var P=Object.defineProperty;var X=(d,t,e)=>t in d?P(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var c=(d,t,e)=>X(d,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();const H=class H{static prnt(t){console.log(t)}static str(t,e){const s=t.toString();if(s.length>=e)return s;const n=e-s.length;return s+H.emptyString.substring(0,n)}static sum(t){return!t||(t=t.filter(e=>e!==0),t.length===0)?0:t.reduce((e,s)=>e+s,0)}static toString(t){return`[${Array.from(t).map(String).join(", ")}]`}static px(){return(t,e)=>t}static equalArrays(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0}static shuffleArray(t){return t.sort(()=>Math.random()-.5)}};c(H,"emptyString","                                           ");let u=H;class G{static save(t,e){u.prnt(t),u.prnt(e)}}var r=(d=>(d.L="L",d.R="R",d.U="U",d.D="D",d))(r||{});class k{constructor(t,e){this.key=t,this.value=e}getKey(){return this.key}getValue(){return this.value}static P(t,e){return new k(t,e)}}class b{static blue(t){return`\x1B[34m${t}\x1B[0m`}static green(t){return`\x1B[32m${t}\x1B[0m`}static color(t,e){return`\x1B[${e}m${t}\x1B[0m`}static clearScreen(){console.log("clearScrn ... ")}}class p{static makeMove(t,e){const n=t.indexOf(-1),i=this.getXY(n);let l=i.getKey(),o=i.getValue();e===r.L&&(l-=1),e===r.R&&(l+=1),e===r.U&&(o-=1),e===r.D&&(o+=1);const h=this.getIndex(l,o),g=[...t],f=g[h];return g[n]=f,g[h]=-1,g}static getXY(t){const e=t%4,s=Math.floor(t/4);return k.P(e,s)}static getIndex(t,e){return e*4+t}static _getValidMoves(t){const e=this.getXY(t),s=Object.values(r).slice();return e.getKey()===0&&s.splice(s.indexOf(r.L),1),e.getKey()===3&&s.splice(s.indexOf(r.R),1),e.getValue()===0&&s.splice(s.indexOf(r.U),1),e.getValue()===3&&s.splice(s.indexOf(r.D),1),s}static getValidMoves(t,e){const s=this._getValidMoves(t),n=this.getXY(t);return this.contains(e,n.getKey()-1,n.getValue())&&s.splice(s.indexOf(r.L),1),this.contains(e,n.getKey()+1,n.getValue())&&s.splice(s.indexOf(r.R),1),this.contains(e,n.getKey(),n.getValue()-1)&&s.splice(s.indexOf(r.U),1),this.contains(e,n.getKey(),n.getValue()+1)&&s.splice(s.indexOf(r.D),1),s}static contains(t,e,s){return t.includes(this.getIndex(e,s))}static stateAsString(t,e){return Array.from({length:16},(s,n)=>{let i;const l=t[n];return l===-1?i=b.blue("*"):e.includes(l)?i=b.color(l.toString(),100):e.includes(n+1)?i=b.green(l.toString()):i=l.toString(),i+="	",n!==0&&(n+1)%4===0&&(i+=`
`),i}).join("")}static getReverseAction(t){return t===r.D?r.U:t===r.U?r.D:t===r.L?r.R:t===r.R?r.L:null}}class x{static main(){const t=E.generateLessons()[0];let e=[...t.getState()];const s=[...t.getGoals()];x.prntState(e,s),e=x.shuffle(e,t.getLockedStateElements(),1e3),x.prntState(e,s)}static shuffle(t,e,s){const n=e.map(l=>l-1);let i=0;for(;i<s;)t=x.makeRandomMove(t,n),i++;return t}static prntState(t,e){u.prnt(p.stateAsString(t,e))}static makeRandomMove(t,e){const s=t.indexOf(-1),n=p.getValidMoves(s,e),i=u.shuffleArray(n)[0];return t=p.makeMove(t,i),t}}const a=class a{constructor(t){c(this,"goals");c(this,"lockedStateElements");c(this,"state");c(this,"episodesToTrain");c(this,"lessonNb");this.lessonNb=t,this.goals=[],this.lockedStateElements=[],this.state=[],this.episodesToTrain=0}getState(){return this.state}getGoals(){return this.goals}getLockedStateElements(){return this.lockedStateElements}getEpisodesToTrain(){return this.episodesToTrain}static generateLessons0(){return[a.state1(0),a.moveHole(a.stateX(2,1),[1,4]),a.moveHole(a.stateX(3,2),[2,5]),a.moveHole(a.state3_4(3),[3,6]),a.moveHole(a.stateX(5,4),[6,7]),a.moveHole(a.stateX(6,5),[5,8]),a.moveHole(a.stateX(7,6),[6,9]),a.moveHole(a.state7_8(7),[8,11]),a.moveHole(a.state9_13(8),[10,11]),a.moveHole(a.state10_15(9),[9,13]),a.state12(10)]}static generateLessonsV1(){return[a.state1_2(0),a.moveHole(a.state3_4(1),[2,3,4]),a.moveHole(a.stateX(5,2),[6,7]),a.moveHole(a.stateX(6,3),[5,8]),a.moveHole(a.stateX(7,4),[6,9]),a.moveHole(a.state7_8(5),[8,11]),a.moveHole(a.state9_13(6),[10,11]),a.moveHole(a.state10_15(7),[9,13]),a.state12(8)]}static generateLessons(){return[a.state1_2(0),a.moveHole(a.state3_4(1),[2,3,4]),a.moveHole(a.state5_6(2),[6,7]),a.moveHole(a.state7_8(3),[8,9,6]),a.moveHole(a.state9_13(4),[10,11]),a.moveHole(a.state10_15(5),[9,13]),a.state12(6)]}static state1_2(t){const e=new a(t);return e.goals=[1,2],e.lockedStateElements=[],e.state=[...a.stateDone],e.episodesToTrain=100,a.shuffle(e,e.lockedStateElements),e}static state1(t){return a.stateX(1,t)}static state3_4(t){const e=new a(t);return e.goals=[3,4],e.lockedStateElements=[1,2],e.state=[...a.stateDone],e.episodesToTrain=100,a.shuffle(e,[1,2,3]),e}static state5_6(t){const e=new a(t);return e.goals=[5,6],e.lockedStateElements=[1,2,3,4],e.state=[...a.stateDone],e.episodesToTrain=100,a.shuffle(e,e.lockedStateElements),e}static stateX(t,e){const s=new a(e);return s.goals=[t],s.lockedStateElements=Array.from({length:t-1},(n,i)=>i+1),s.state=[...a.stateDone],s.episodesToTrain=100,a.shuffle(s,s.lockedStateElements),s}static moveHole(t,e){const s=u.shuffleArray(e)[0],n=t.state.indexOf(-1),i=t.state[s];return t.state[s]=-1,t.state[n]=i,t}static state7_8(t){const e=new a(t);return e.goals=[7,8],e.lockedStateElements=[1,2,3,4,5,6],e.state=[...a.stateDone],e.episodesToTrain=100,a.shuffle(e,[1,2,3,4,5,6,7]),e}static state9_13(t){const e=new a(t);return e.goals=[9,13],e.lockedStateElements=[1,2,3,4,5,6,7,8],e.state=[...a.stateDone],e.episodesToTrain=100,a.shuffle(e,e.lockedStateElements),e}static state10_15(t){const e=new a(t);return e.goals=[10,11,14,15],e.lockedStateElements=[1,2,3,4,5,6,7,8,9,13],e.state=x.shuffle([...a.stateDone],e.lockedStateElements,500),e.episodesToTrain=100,e}static state12(t){const e=new a(t);return e.goals=[12],e.lockedStateElements=[1,2,3,4,5,6,7,8,9,10,11,13,14,15],e.state=x.shuffle([...a.stateDone],e.lockedStateElements,500),e.episodesToTrain=10,e}isLockedIndex(t){return this.lockedStateElements.includes(t+1)}shuffleState(){this.state=x.shuffle(this.state,this.lockedStateElements,500)}static shuffle(t,e){let s=t.state.filter(n=>!e.includes(n));s=u.shuffleArray(s),t.state=[...e,...s]}resetState(){const t=a.generateLessons()[this.lessonNb];this.goals=[...t.goals],this.lockedStateElements=[...t.lockedStateElements],this.state=[...t.state]}};c(a,"stateDone",[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,-1]);let E=a;class v{constructor(t,e){c(this,"state");c(this,"goals");c(this,"fixedElements");t instanceof v?(this.state=[...t.getState()],this.goals=[...t.getGoals()],this.fixedElements=[...t.getFixedElements()]):(this.state=[...t],this.goals=[...(e==null?void 0:e.getGoals())??[]],this.fixedElements=[...(e==null?void 0:e.getLockedStateElements())??[]])}getState(){return this.state}setState(t){this.state=t}getGoals(){return this.goals}setGoals(t){this.goals=t}getFixedElements(){return this.fixedElements}setFixedElements(t){this.fixedElements=t}getHashCodeV2(){const t=this.getHashCodeV3__();return this.hashString(t)}getHashCodeV3__(){return Array.from({length:16},(t,e)=>{let s;const n=this.state[e];return n===-1?s="*":this.goals.includes(n)?s=String(n):this.goals.includes(e+1)?s="o":s=" ",s=s+"	",e!==0&&(e+1)%4===0&&(s=s+`
`),s}).join("")}getHashCode(){const t=this.state.map(String).join(",");return this.hashString(t)}hashString(t){let e=0;for(let s=0;s<t.length;s++){const n=t.charCodeAt(s);e=(e<<5)-e+n,e|=0}return e}equals(t){return this.getHashCode()===t.getHashCode()}hashCode(){return this.getHashCode()}}class ${constructor(t,e,s=0,n=!1){c(this,"state");c(this,"action");c(this,"reward");c(this,"isTerminal");this.state=t,this.action=e,this.reward=s,this.isTerminal=n}}const m=class m{constructor(t){c(this,"state");c(this,"goals");c(this,"reverseAction",null);c(this,"bigCircleAction1",[]);c(this,"bigCircleAction2",[]);c(this,"smallCircleAction1",[]);c(this,"smallCircleAction2",[]);c(this,"circleAction",[]);m.stateProducer=t,m.stateProducer.resetState();const e=m.stateProducer.getState();this.goals=m.stateProducer.getGoals(),this.state=new v(e,m.stateProducer)}static isTerminalSuccess(t){return m._isTerminalSuccess(t.getState(),t.getGoals())}reset(){this.reverseAction=null,this.circleAction=[],this.bigCircleAction1=[],this.bigCircleAction2=[],this.smallCircleAction1=[],this.smallCircleAction2=[],this.bigCircleAction1.push(r.L,r.L,r.D,r.D,r.R,r.R,r.U,r.U),this.bigCircleAction2.push(r.R,r.R,r.D,r.D,r.L,r.L,r.U,r.U),this.smallCircleAction1.push(r.L,r.D,r.R,r.U,r.L),this.smallCircleAction2.push(r.R,r.D,r.L,r.U,r.R)}getInitState(){m.stateProducer.resetState();const t=m.stateProducer.getState();return this.goals=m.stateProducer.getGoals(),this.state=new v(t,m.stateProducer),this.state}static getPossibleActions(t){const e=t.getState().indexOf(-1),s=t.getFixedElements().map(n=>n-1);return p.getValidMoves(e,s)}executeAction(t,e){const s=p.makeMove(t.getState(),e),n=new v(s,m.stateProducer);let i=m._isTerminalSuccess(s,this.goals);this.state=new v(s,m.stateProducer);let l=NaN;this.reverseAction=p.getReverseAction(e),this.circleAction.push(e),this.circleAction.length>8&&this.circleAction.shift(),(u.equalArrays(this.circleAction,this.bigCircleAction1)||u.equalArrays(this.circleAction,this.bigCircleAction2)||u.equalArrays(this.circleAction,this.smallCircleAction1)||u.equalArrays(this.circleAction,this.smallCircleAction2))&&(i=!0);const o=this.state.getState().indexOf(-1);return m.stateProducer.isLockedIndex(o)&&(i=!0,l=-1),isNaN(l)&&(l=this.getReward(s,this.goals)),new $(n,e,l,i)}static _isTerminalSuccess(t,e){if(t.length!==16)throw new Error("newState.size() != 16");return e.filter(s=>t[s-1]===s).length===e.length}prntInfo(){u.prnt(`

================================================
`);const t=this.state.getState(),e=t.indexOf(-1),s=p.getXY(e);u.prnt(s);const n=p.getIndex(s.getKey(),s.getValue());u.prnt(`${e} - ${n}`);const i=p._getValidMoves(e);u.prnt(i);const l=this.getReward(t,this.goals);u.prnt(l);const o=p.stateAsString(t,this.goals);u.prnt(o)}getReward(t,e){const s=t.indexOf(-1),n=p.getXY(s),l=e.map(h=>this.getDistance(p.getXY(t.indexOf(h)),p.getXY(h-1))).reduce((h,g)=>h+g,0);if(l===0)return 100.5;const o=e.reduce((h,g)=>h+this.getDistance(p.getXY(t.indexOf(g)),n),0);return u.prnt(`d0Sum: ${l}`),u.prnt(`d1Sum: ${o}`),1/(l+o)}getDistance(t,e){const s=Math.pow(e.getKey()-t.getKey(),2),n=Math.pow(e.getValue()-t.getValue(),2);return Math.sqrt(s+n)}};c(m,"stateProducer");let w=m;class O{constructor(t,e,s,n,i){c(this,"state");c(this,"action");c(this,"reward");c(this,"done");c(this,"newState");this.state=new v(t),this.action=e,this.reward=s,this.done=n,this.newState=new v(i)}getState(){return this.state}getAction(){return this.action}getReward(){return this.reward}isDone(){return this.done}getNewState(){return this.newState}equals(t){return t instanceof O?this.hashCode()===t.hashCode():!1}hashCode(){return this.state.getHashCodeV2()^this.newState.getHashCodeV2()}}class B{constructor(t){c(this,"state");c(this,"qValues");this.state=t,this.qValues=new Map}setValue(t,e){const s=w.getPossibleActions(this.state);if(this.qValues.size===0&&s.forEach(n=>this.qValues.set(n,0)),!s.includes(t)){console.warn("WARNING: !moves.includes(action)");return}this.qValues.set(t,e)}getValue(t){return this.qValues.get(t)||0}getActionWithMaxValue(t){const e=w.getPossibleActions(this.state).filter(n=>n!==t),s=t===null?null:this.getAction(t);return s??(console.warn("WARNING: no action found"),e.length>0?e[0]:r.D)}getAction(t){const s=Array.from(this.qValues.entries()).filter(([n])=>n!==t).reduce((n,i)=>i[1]>n[1]?i:n,[t,-1/0]);return s[1]>-1/0?s[0]:void 0}getMaxValue(){return this.qValues.size===0?0:Math.max(...Array.from(this.qValues.values()))}}class Q{static updateQTable(t,e,s,n,i,l,o,h){let g;if(l)g=i;else{const f=this.getQValue(t,e,s),T=this.getMaxQValue(t,n);g=this.calcQValue(i,f,T,h,o)}this.addStateWithZeroValuesToQTableIfStateNotExist(t,e),this.updateQTableEntry(t,e.getHashCodeV2(),s,g)}static updateQTableEntry(t,e,s,n){var i;(i=t.get(e))==null||i.setValue(s,n)}static getMaxQValue(t,e){var n;const s=e.getHashCodeV2();return this.addStateWithZeroValuesToQTableIfStateNotExist(t,e),((n=t.get(s))==null?void 0:n.getMaxValue())??0}static getQValue(t,e,s){var i;const n=e.getHashCodeV2();return this.addStateWithZeroValuesToQTableIfStateNotExist(t,e),((i=t.get(n))==null?void 0:i.getValue(s))??0}static addStateWithZeroValuesToQTableIfStateNotExist(t,e){t.has(e.getHashCodeV2())||this.addStateWithZeroValuesToQTable(t,e)}static addStateWithZeroValuesToQTable(t,e){const s=e.getHashCodeV2(),n=new B(e);t.set(s,n)}static calcQValue(t,e,s,n,i){return e+i*(t+n*s-e)}}const y=class y{static runEpisode(t,e,s,n,i){const l=new U,o=new w(t);o.reset();let h=o.getInitState();o.prntInfo();const g=.5;let f=!1,T=0;for(;!f&&T<50;){T++;let S;const A=w.getPossibleActions(h);if(o.reverseAction!==null){const q=A.indexOf(o.reverseAction);A.splice(q,1)}l.nextDouble()<g?(console.log(`
rndm move`),S=C.getRandomAction(A)):(console.log(`
qTable move`),S=C.getAction(e,h,o.reverseAction),A.includes(S)||(S=C.getAction(e,h,o.reverseAction))),console.log(`
--------------------------------------------------------`),console.log(`
action: `+S),A.includes(S);const V=o.executeAction(h,S),M=V.state;o.prntInfo();const I=V.reward;f=V.isTerminal,f&&(f=!0);const N=new O(h,S,I,f,M);y.experience.add(N),h=V.state}y.replayExperience(y.experience,e,n,s,1e3);const D=Array.from(e.values()).reduce((S,A)=>S+A.qValues.size,0),L=`Episode ${i} done, states count: ${D}, experience size: ${y.experience.size}`;console.log(L),console.log("")}static replayExperience(t,e,s,n,i){Array.from(t).sort(()=>Math.random()-.5).slice(0,i).forEach(o=>{Q.updateQTable(e,o.getState(),o.getAction(),o.getNewState(),o.getReward(),o.isDone(),s,n)})}};c(y,"experience",new Set);let R=y;class U{nextDouble(){return Math.random()}}class K{static train(t,e,s){const l=E.generateLessons(),o=(g,f)=>{R.runEpisode(g,t,.9,.1,f)},h=g=>{for(let f=0;f<g.getEpisodesToTrain();f++)o(g,f)};for(let g=0;g<s;g++)l.forEach(h);console.log(`
training done`),G.save(e,t)}}class C{static train(){const t="qTable.ser",e=this.loadQTable(t);K.train(e,t,10)}static test(){const e=this.loadQTable("qTable.ser");for(;;)this.testQTable(e)}static loadQTable(t){let e=new Map;try{u.prnt(t),u.prnt("qTable not loaded .. newwd to implement .. use some local storage ")}catch(n){u.prnt(n)}const s=this.getStatistics(e);return u.prnt(s),e}static getStatistics(t){const e=Array.from(t.values()).flatMap(o=>Array.from(o.qValues.values())),s=e.reduce((o,h)=>o+h,0),n=e.length,i=n?s/n:0,l=new W;return l.count=n,l.sum=s,l.average=i,l}static testQTable(t){u.prnt("********************* test q table **********************"),u.prnt("********************* test q table **********************"),u.prnt("********************* test q table **********************");let e=0;const s=E.generateLessons(),n=s.length;let i=s[e],l=x.shuffle(E.stateDone,[],1e3),o=new v(l,i),h=i.getGoals();this.prntState(o);let g=!1,f=0,T=null;for(;!g&&f<200;){this.sleep(1e3/2).then(),b.clearScreen(),f++;const L=o.getHashCodeV2();Q.addStateWithZeroValuesToQTableIfStateNotExist(t,o);const S=t.get(L),A=S?S.getActionWithMaxValue(T):r.D;T=p.getReverseAction(A);const V=p.makeMove(o.getState(),A),M=w._isTerminalSuccess(V,h);o=new v(V,i),g=u.equalArrays(o.getState(),E.stateDone),u.prnt(`${f}
----
`),this.prntState(o),M&&!g&&e<n-1&&(e++,i=s[e],h=i.getGoals(),u.prnt(`lesson change: ${e}`),u.prnt(h),o=new v(o.getState(),i))}const D=w.isTerminalSuccess(o);u.prnt(`success: ${D}`),this.sleep(3e3).then()}static prntState(t){const e=p.stateAsString(t.getState(),t.getGoals());u.prnt(e)}static getAction(t,e,s){var l;const n=e.getHashCodeV2();let i=w.getPossibleActions(e);return i=i.filter(o=>o!==s),t.has(n)?((l=t.get(n))==null?void 0:l.getActionWithMaxValue(s))||r.D:this.getRandomAction(i)}static getRandomAction(t){return t.length>0?t[Math.floor(Math.random()*t.length)]:r.D}static sleep(t){return new Promise(e=>setTimeout(e,t))}}class W{constructor(){c(this,"count",0);c(this,"sum",0);c(this,"average",0)}}class Y{static main(){u.prnt("kuku"),C.train(),C.test()}}function j(d){var n,i,l;let t=0;const e=o=>o>=100?o-100:o<=-100?o+100:o,s=o=>{t=e(o);const h=`${t}`;d.innerHTML=h};(n=document.getElementById("increaseByOne"))==null||n.addEventListener("click",()=>s(t+1)),(i=document.getElementById("decreaseByOne"))==null||i.addEventListener("click",()=>s(t-1)),(l=document.getElementById("increaseByTwo"))==null||l.addEventListener("click",()=>s(t+2)),document.getElementById("decreaseByTwo"),s(0)}j(document.getElementById("counter-value"));Y.main();
